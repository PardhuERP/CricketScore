<!DOCTYPE html>
<html>
<head>
  <title>Opening Players</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; background:#0f172a; color:#fff; margin:0; }
    .header { background:#020617; padding:15px; text-align:center; font-weight:bold; }
    .container { padding:20px; }
    select, button { width:100%; padding:12px; margin-top:10px; border-radius:6px; border:none; }
    button { background:#22c55e; color:#000; font-weight:bold; }
    .card { background:#1e293b; padding:15px; border-radius:10px; }
  </style>
</head>

<body>

<div class="header">Opening Players</div>
<div class="container">
  <div class="card">
    <div id="matchInfo"></div>

    <h4>Batting Team</h4>
    <select id="striker"></select>
    <select id="nonStriker"></select>

    <h4>Bowling Team</h4>
    <select id="bowler"></select>

    <button onclick="saveOpening()">Start Match</button>
  </div>
</div>


 <script src="config.js"></script> 

<script>
const token = localStorage.getItem("token");
const matchId = new URLSearchParams(window.location.search).get("matchId");

let battingTeamId, bowlingTeamId;
let battingPlayers = [], bowlingPlayers = [];

fetch(API + "?action=getMatch&matchId=" + matchId)
  .then(r => r.json())
  .then(d => {

    // FIRST: check opening players
    fetch(API + "?action=getOpeningPlayers&matchId=" + matchId)
      .then(r2 => r2.json())
      .then(op => {
        if (op.data) {
          // Already set by someone
          window.location.href = "scoreboard.html?matchId=" + matchId;
          return;
        }

        // ONLY if not set, continue with normal logic
        const m = d.match;
        const tossWinner = m[10];
        const tossDecision = m[11];

        if (tossDecision == "BAT") {
          battingTeamId = tossWinner;
          bowlingTeamId = (tossWinner == m[2]) ? m[3] : m[2];
        } else {
          bowlingTeamId = tossWinner;
          battingTeamId = (tossWinner == m[2]) ? m[3] : m[2];
        }

        matchInfo.innerHTML = `
          <b>Batting:</b> ${battingTeamId == m[2] ? d.teamAName : d.teamBName}<br>
          <b>Bowling:</b> ${bowlingTeamId == m[2] ? d.teamAName : d.teamBName}
        `;

        loadPlaying11();
      });

  });

function getTeamNameLocal(id){
  return id; // only for display fallback
}

function loadPlaying11() {
  fetch(API + "?action=getPlaying11&matchId=" + matchId + "&teamId=" + battingTeamId)
    .then(r => r.json())
    .then(d => {
      battingPlayers = d.players;
      fillDropdown(striker, battingPlayers, "Select Striker");
      fillDropdown(nonStriker, battingPlayers, "Select Non-Striker");
    });

  fetch(API + "?action=getPlaying11&matchId=" + matchId + "&teamId=" + bowlingTeamId)
    .then(r => r.json())
    .then(d => {
      bowlingPlayers = d.players;
      fillDropdown(bowler, bowlingPlayers, "Select Bowler");
    });
}

function fillDropdown(el, list, label) {
  el.innerHTML = `<option value="">${label}</option>`;
  list.forEach(p => {
    el.innerHTML += `<option value="${p[2]}">${p[2]}</option>`;
  });
}

function saveOpening() {
  if (!striker.value || !nonStriker.value || !bowler.value) {
    alert("Select all players");
    return;
  }
  if (striker.value === nonStriker.value) {
    alert("Striker and Non-Striker cannot be same");
    return;
  }

  fetch(API + "?action=saveOpeningPlayers", {
    method:"POST",
    body: JSON.stringify({
      matchId: matchId,
      strikerId: striker.value,
      nonStrikerId: nonStriker.value,
      bowlerId: bowler.value
    })
  })
  .then(r => r.json())
  .then(d => {
    alert("Match Started");
    window.location.href = "https://script.google.com/macros/s/AKfycbyxqGY4gx6SPBqwqJAi4q3_RP1hzYie1DO-AeFJ_WREkPt3DPDWnoBUIFMSOs9kC2Ao/exec?matchId=" + matchId;
  });
}
</script>

</body>
</html>
