<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Score Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f2f4f8}
.header{background:#0a7cff;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:bold;display:flex;align-items:center}
.back{margin-right:10px;font-size:20px;cursor:pointer}
.container{padding:14px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 4px 10px rgba(0,0,0,0.08);text-align:center}
.score{font-size:28px;font-weight:bold}
.sub{color:#555;margin-top:4px}
.small{font-size:14px;margin-top:4px;color:#333}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
button{padding:14px;font-size:18px;border:none;border-radius:10px;cursor:pointer;background:#0a7cff;color:#fff}
.wicket{background:#e53935}
.extra{background:#ff9800}
.mic-btn{margin-top:10px;background:#e53935;width:80px;height:80px;border-radius:50%;font-size:36px}
select{width:100%;padding:10px;margin-top:8px}
</style>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzdz3UnRjf-nDbzd9WCdKpQG32jXc1ehGKeXy9q_Czm8ASwHSszmvWlNQa8OSL-6VE/exec";

/* ===== LOCAL LIVE STATS ===== */
let batRuns=0, batBalls=0;
let nonRuns=0, nonBalls=0;
let bowlerBalls=0;
let waitForNewBowler=false;

/* JSONP */
function callAPI(p,cb){
  const f="cb_"+Date.now();
  window[f]=r=>{cb&&cb(r);delete window[f];s.remove()};
  const q=Object.keys(p).map(k=>k+"="+encodeURIComponent(p[k])).join("&");
  const s=document.createElement("script");
  s.src=API_URL+"?"+q+"&callback="+f;
  document.body.appendChild(s);
}

/* ENABLE / DISABLE */
function disableEntry(d){
  document.querySelectorAll(".score-btn").forEach(b=>{
    b.disabled=d;
    b.style.opacity=d?"0.4":"1";
  });
}

/* UI UPDATE */
function updateUI(r){
  if(!r) return;

  score.innerText=(r.runs||0)+" / "+(r.wickets||0);
  overs.innerText="Overs: "+(r.overs||"0.0");

  strikerBox.innerText=`üèè ${r.striker||"-"} : ${batRuns} (${batBalls})`;
  nonBox.innerText=`üèè ${r.nonstriker||"-"} : ${nonRuns} (${nonBalls})`;
  bowlerBox.innerText=`üéØ ${r.bowler||"-"} : ${bowlerBalls} balls`;

  /* 1ST INNINGS END */
  if(r.inningsStatus==="ENDED" && r.inningsNo==1){
    secondBtn.style.display="block";
    disableEntry(true);
  }

  /* 2ND INNINGS SETUP */
  if(r.inningsStatus==="SETUP"){
    setupCard.style.display="block";
    disableEntry(true);

    s2.innerHTML="<option value=''>Select Batsman 1</option>";
    ns2.innerHTML="<option value=''>Select Batsman 2</option>";
    b2.innerHTML="<option value=''>Select Bowler</option>";

    loadPlayers(r.batting,"s2","ns2");
    loadPlayers(r.bowling,"b2");
  }

  /* ‚úÖ FIXED LIVE LOGIC */
  if(r.inningsStatus==="LIVE"){
    setupCard.style.display="none";
    secondBtn.style.display="none";

    if(waitForNewBowler){
      disableEntry(true);
    }else{
      disableEntry(false);
    }
  }

  /* MATCH COMPLETED */
  if(r.inningsStatus==="COMPLETED"){
    disableEntry(true);
    alert("üèÜ Match Completed");
    location.href="dashboard.html";
  }
}

/* SCORE */
function send(t,v=0){
  if(waitForNewBowler){
    alert("Select new bowler");
    return;
  }

  if(t==="run"){
    batRuns+=v; batBalls++; bowlerBalls++;
    if(v%2===1){
      [batRuns,nonRuns]=[nonRuns,batRuns];
      [batBalls,nonBalls]=[nonBalls,batBalls];
    }
  }

  if(t==="wicket"){
    batBalls++; bowlerBalls++;
    batRuns=0; batBalls=0;
  }

  /* OVER COMPLETE */
  if(bowlerBalls>0 && bowlerBalls%6===0){
    waitForNewBowler=true;
    alert("Over completed. Select new bowler.");
    setupBowlerChange();
  }

  callAPI({action:"updateScore",type:t,value:v},
    ()=>callAPI({action:"getLiveScore"},updateUI)
  );
}

/* CHANGE BOWLER */
function setupBowlerChange(){
  setupCard.style.display="block";
  s2.style.display="none";
  ns2.style.display="none";
  b2.style.display="block";

  callAPI({action:"getLiveScore"},r=>{
    loadPlayers(r.bowling,"b2");
  });
}

/* CONFIRM */
function confirmPlayers(){
  bowlerBalls=0;
  waitForNewBowler=false;

  callAPI({
    action:"setSecondInningsPlayers",
    striker:s2.value||undefined,
    nonstriker:ns2.value||undefined,
    bowler:b2.value
  },()=>callAPI({action:"getLiveScore"},updateUI));
}

/* LOAD PLAYERS */
function loadPlayers(team,...ids){
  callAPI({action:"getPlayers",team:team},p=>{
    ids.forEach(id=>{
      const s=document.getElementById(id);
      p.forEach(x=>s.innerHTML+=`<option>${x.name}</option>`);
    });
  });
}

/* SECOND INNINGS */
function startSecondInnings(){
  batRuns=batBalls=nonRuns=nonBalls=bowlerBalls=0;
  waitForNewBowler=false;

  callAPI({action:"startSecondInnings"},r=>{
    alert("Target: "+r.target);
    callAPI({action:"getLiveScore"},updateUI);
  });
}

/* MIC */
let rec;
function startMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert("Mic not supported");return;}
  rec=new SR();
  rec.lang="en-IN";
  rec.onresult=e=>{
    const t=e.results[0][0].transcript.toLowerCase();
    if(t.includes("six")) send("run",6);
    else if(t.includes("four")) send("run",4);
    else if(t.includes("three")) send("run",3);
    else if(t.includes("two")) send("run",2);
    else if(t.includes("one")) send("run",1);
    else if(t.includes("zero")) send("run",0);
    else if(t.includes("wide")) send("wide");
    else if(t.includes("no")) send("noball");
    else if(t.includes("wicket")||t.includes("out")) send("wicket");
  };
  rec.start();
}

window.onload=()=>callAPI({action:"getLiveScore"},updateUI);
</script>
</head>

<body>
<div class="header">
  <div class="back" onclick="location.href='dashboard.html'">‚¨Ö</div>
  Score Entry
</div>

<div class="container">

<div class="card">
  <div class="score" id="score">0 / 0</div>
  <div class="sub" id="overs">Overs: 0.0</div>

  <div class="small" id="strikerBox"></div>
  <div class="small" id="nonBox"></div>
  <div class="small" id="bowlerBox"></div>

  <button id="secondBtn" style="display:none;background:#4caf50" onclick="startSecondInnings()">‚ñ∂ Start 2nd Innings</button>
</div>

<div class="card" id="setupCard" style="display:none">
  <h3>Player Selection</h3>
  <select id="s2"></select>
  <select id="ns2"></select>
  <select id="b2"></select>
  <button style="margin-top:10px;background:#4caf50" onclick="confirmPlayers()">Confirm</button>
</div>

<div class="card">
  <div class="grid">
    <button class="score-btn" onclick="send('run',0)">0</button>
    <button class="score-btn" onclick="send('run',1)">1</button>
    <button class="score-btn" onclick="send('run',2)">2</button>
    <button class="score-btn" onclick="send('run',3)">3</button>
    <button class="score-btn" onclick="send('run',4)">4</button>
    <button class="score-btn" onclick="send('run',6)">6</button>
  </div>
</div>

<div class="card">
  <div class="grid">
    <button class="extra score-btn" onclick="send('wide')">Wide</button>
    <button class="extra score-btn" onclick="send('noball')">No Ball</button>
    <button class="wicket score-btn" onclick="send('wicket')">Wicket</button>
  </div>
</div>

<div class="card">
  <button class="mic-btn" onclick="startMic()">üé§</button>
  <div class="sub">Speak: one, two, four, six, wide, no ball, wicket</div>
</div>

</div>
</body>
</html>
