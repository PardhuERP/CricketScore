<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Score Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f2f4f8}
.header{background:#0a7cff;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:bold;display:flex;align-items:center}
.back{margin-right:10px;font-size:20px;cursor:pointer}
.container{padding:14px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 4px 10px rgba(0,0,0,0.08);text-align:center}
.score{font-size:28px;font-weight:bold}
.sub{color:#555;margin-top:4px}
.small{font-size:14px;margin-top:4px;color:#333}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
button{padding:14px;font-size:18px;border:none;border-radius:10px;cursor:pointer;background:#0a7cff;color:#fff}
.wicket{background:#e53935}
.extra{background:#ff9800}
select{width:100%;padding:10px;margin-top:8px}
</style>

<script>
const API_URL =
"https://script.google.com/macros/s/AKfycbzdz3UnRjf-nDbzd9WCdKpQG32jXc1ehGKeXy9q_Czm8ASwHSszmvWlNQa8OSL-6VE/exec";

/* ===== STATE ===== */
let waitingForNewBatsman = false;
let bowlerChangedForThisOver = false;

/* ===== JSONP ===== */
function callAPI(p,cb){
  const f="cb_"+Date.now();
  window[f]=r=>{cb&&cb(r);delete window[f];s.remove()};
  const q=Object.keys(p).map(k=>k+"="+encodeURIComponent(p[k])).join("&");
  const s=document.createElement("script");
  s.src=API_URL+"?"+q+"&callback="+f;
  document.body.appendChild(s);
}

/* ===== HELPERS ===== */
function disableEntry(d){
  document.querySelectorAll(".score-btn").forEach(b=>{
    b.disabled=d;
    b.style.opacity=d?"0.4":"1";
  });
}

/* ===== UI UPDATE ===== */
function updateUI(r){
  if(!r) return;

  score.innerText = `${r.runs} / ${r.wickets}`;
  overs.innerText = "Overs: " + r.overs;

  const bs = r.batsmanStats || {};
  const bls = r.bowlerStats || {};

  strikerBox.innerText =
    r.striker && bs[r.striker]
      ? `ðŸ ${r.striker} : ${bs[r.striker].runs} (${bs[r.striker].balls})`
      : "";

  nonBox.innerText =
    r.nonstriker && bs[r.nonstriker]
      ? `ðŸ ${r.nonstriker} : ${bs[r.nonstriker].runs} (${bs[r.nonstriker].balls})`
      : "";

  bowlerBox.innerText =
    r.bowler && bls[r.bowler]
      ? `ðŸŽ¯ ${r.bowler} : ${bls[r.bowler].balls} balls`
      : "";

  swapBtn.style.display = r.inningsStatus==="LIVE" ? "block" : "none";

  /* ===== 2ND INNINGS SETUP ===== */
  if(r.inningsStatus==="SETUP" && r.inningsNo===2){
    loadSecondInnings();
    return;
  }else{
    secondInningsCard.style.display="none";
  }

  /* ===== OVER END ===== */
  const overEnded =
    r.inningsStatus==="LIVE" &&
    r.totalBalls>0 &&
    r.totalBalls%6===0 &&
    r.totalBalls < r.oversLimit*6;

  if(overEnded && !bowlerChangedForThisOver){
    changeBowlerBtn.style.display="block";
    disableEntry(true);
  }else{
    changeBowlerBtn.style.display="none";
    if(!waitingForNewBatsman){
      disableEntry(r.inningsStatus!=="LIVE");
    }
  }

  /* ===== END 1ST INNINGS ===== */
  if(r.inningsStatus==="ENDED" && r.inningsNo===1){
    endInningsBtn.style.display="block";
    disableEntry(true);
  }else{
    endInningsBtn.style.display="none";
  }

  /* ===== MATCH COMPLETED (FINAL FIX) ===== */
  if(r.inningsStatus==="COMPLETED"){
    let msg = "";

    if(r.result === "DRAW"){
      msg = "Match Drawn ðŸ¤";
    }
    else if(r.result === "CHASED"){
      msg = `${r.batting} won by ${10 - r.wickets} wickets`;
    }
    else if(r.result === "DEFENDED"){
      msg = `${r.bowling} won by ${r.target - r.runs - 1} runs`;
    }

    alert("ðŸ† " + msg);
    location.href="dashboard.html";
  }
}

/* ===== SCORE ENTRY ===== */
function send(type,value=0){
  if(waitingForNewBatsman){
    alert("Select new batsman first");
    return;
  }

  callAPI(
    {action:"updateScore",type,value},
    ()=>{
      if(type==="wicket"){
        waitingForNewBatsman = true;
        disableEntry(true);
        openNewBatsman();
      }
      callAPI({action:"getLiveScore"},updateUI);
    }
  );
}

/* ===== NEW BATSMAN ===== */
function openNewBatsman(){
  newBatCard.style.display="block";
  newBat.innerHTML="<option value=''>Select New Batsman</option>";

  callAPI({action:"getLiveScore"},r=>{
    callAPI({action:"getPlayers",team:r.batting},players=>{
      players.forEach(p=>{
        const o=document.createElement("option");
        o.value=o.textContent=p.name;
        newBat.appendChild(o);
      });
    });
  });
}

function confirmNewBatsman(){
  if(!newBat.value) return alert("Select batsman");

  callAPI(
    {action:"setNewBatsman",batsman:newBat.value},
    ()=>{
      waitingForNewBatsman=false;
      newBatCard.style.display="none";
      disableEntry(false);
      callAPI({action:"getLiveScore"},updateUI);
    }
  );
}

/* ===== CHANGE BOWLER ===== */
function openBowlerChange(){
  setupCard.style.display="block";
  b2.innerHTML="<option value=''>Select Bowler</option>";

  callAPI({action:"getLiveScore"},r=>{
    callAPI({action:"getPlayers",team:r.bowling},players=>{
      players.forEach(p=>{
        const o=document.createElement("option");
        o.value=o.textContent=p.name;
        b2.appendChild(o);
      });
    });
  });
}

function confirmBowler(){
  if(!b2.value) return alert("Select bowler");

  callAPI(
    {action:"setBowler",bowler:b2.value},
    ()=>{
      bowlerChangedForThisOver=true;
      setupCard.style.display="none";
      disableEntry(false);
      callAPI({action:"getLiveScore"},updateUI);
    }
  );
}

/* ðŸ” SWAP STRIKE */
function swapStrikeUI(){
  callAPI(
    {action:"swapStrike"},
    ()=>callAPI({action:"getLiveScore"},updateUI)
  );
}

/* ===== 2ND INNINGS SETUP ===== */
function loadSecondInnings(){
  secondInningsCard.style.display="block";
  disableEntry(true);

  s2.innerHTML="<option value=''>Select Striker</option>";
  ns2.innerHTML="<option value=''>Select Non-Striker</option>";
  b2i.innerHTML="<option value=''>Select Bowler</option>";

  callAPI({action:"getLiveScore"},r=>{
    callAPI({action:"getPlayers",team:r.batting},players=>{
      players.forEach(p=>{
        let o1=document.createElement("option");
        o1.value=o1.textContent=p.name;
        s2.appendChild(o1);

        let o2=document.createElement("option");
        o2.value=o2.textContent=p.name;
        ns2.appendChild(o2);
      });
    });

    callAPI({action:"getPlayers",team:r.bowling},players=>{
      players.forEach(p=>{
        let o=document.createElement("option");
        o.value=o.textContent=p.name;
        b2i.appendChild(o);
      });
    });
  });
}

function confirmSecondInnings(){
  if(!s2.value || !ns2.value || !b2i.value)
    return alert("Select all players");

  callAPI(
    {
      action:"setSecondInningsPlayers",
      striker:s2.value,
      nonstriker:ns2.value,
      bowler:b2i.value
    },
    ()=>{
      secondInningsCard.style.display="none";
      disableEntry(false);
      callAPI({action:"getLiveScore"},updateUI);
    }
  );
}

/* ===== END INNINGS ===== */
function endInnings(){
  location.href="dashboard.html";
}

/* ===== INIT ===== */
window.onload=()=>{
  waitingForNewBatsman=false;
  bowlerChangedForThisOver=false;
  callAPI({action:"getLiveScore"},updateUI);
};
</script>
</head>

<body>
<!-- BODY SAME AS YOUR VERSION (UNCHANGED) -->
</body>
</html>
