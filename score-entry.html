<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Score Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f2f4f8}
.header{background:#0a7cff;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:bold;display:flex;align-items:center}
.back{margin-right:10px;font-size:20px;cursor:pointer}
.container{padding:14px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 4px 10px rgba(0,0,0,0.08);text-align:center}
.score{font-size:28px;font-weight:bold}
.sub{color:#555;margin-top:4px}
.small{font-size:14px;margin-top:4px;color:#333}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
button{padding:14px;font-size:18px;border:none;border-radius:10px;cursor:pointer;background:#0a7cff;color:#fff}
.wicket{background:#e53935}
.extra{background:#ff9800}
select{width:100%;padding:10px;margin-top:8px}
</style>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzdz3UnRjf-nDbzd9WCdKpQG32jXc1ehGKeXy9q_Czm8ASwHSszmvWlNQa8OSL-6VE/exec";

/* ===== MATCH STATE ===== */
let striker="", nonStriker="", bowler="";
let batsmen={}, bowlers={};
let overBalls=0;
let isOverComplete=false;
let inningsStatus="LIVE";

/* ===== JSONP ===== */
function callAPI(p,cb){
  const f="cb_"+Date.now();
  window[f]=r=>{cb&&cb(r);delete window[f];s.remove()};
  const q=Object.keys(p).map(k=>k+"="+encodeURIComponent(p[k])).join("&");
  const s=document.createElement("script");
  s.src=API_URL+"?"+q+"&callback="+f;
  document.body.appendChild(s);
}

/* ===== ENABLE / DISABLE ===== */
function disableEntry(disabled){
  document.querySelectorAll(".score-btn").forEach(b=>{
    b.disabled=disabled;
    b.style.opacity=disabled?"0.4":"1";
  });
}

/* ===== UI UPDATE ===== */
function updateUI(r){
  if(!r) return;

  inningsStatus = r.inningsStatus || "LIVE";

  score.innerText = `${r.runs} / ${r.wickets}`;
  overs.innerText = "Overs: " + r.overs;

  strikerBox.innerText = striker ? `ðŸ ${striker} : ${batsmen[striker].runs} (${batsmen[striker].balls})` : "";
  nonBox.innerText = nonStriker ? `ðŸ ${nonStriker} : ${batsmen[nonStriker].runs} (${batsmen[nonStriker].balls})` : "";
  bowlerBox.innerText = bowler ? `ðŸŽ¯ ${bowler} : ${bowlers[bowler].balls} balls` : "";

  /* ================= FIX ================= */

  // INNINGS LIVE â†’ handle over change
  if(inningsStatus==="LIVE"){
    if(isOverComplete){
      changeBowlerBtn.style.display="block";
      disableEntry(true);
    }else{
      changeBowlerBtn.style.display="none";
      disableEntry(false);
    }
    secondInningsBtn.style.display="none";
  }

  // INNINGS ENDED â†’ show 2nd innings
  if(inningsStatus==="ENDED"){
    isOverComplete=false;
    overBalls=0;

    changeBowlerBtn.style.display="none";
    disableEntry(true);

    secondInningsBtn.style.display="block";
  }
}

/* ===== SCORE ENTRY ===== */
function send(type,value=0){
  if(isOverComplete || inningsStatus!=="LIVE") return;

  if(type==="run"){
    batsmen[striker].runs+=value;
    batsmen[striker].balls++;
    bowlers[bowler].balls++;
    overBalls++;

    if(value%2===1){
      [striker,nonStriker]=[nonStriker,striker];
    }
  }

  if(type==="wicket"){
    batsmen[striker].balls++;
    bowlers[bowler].balls++;
    overBalls++;
    batsmen[striker]={runs:0,balls:0};
  }

  if(overBalls===6){
    overBalls=0;
    [striker,nonStriker]=[nonStriker,striker];
    isOverComplete=true;
  }

  callAPI(
    {action:"updateScore",type:type,value:value},
    ()=>callAPI({action:"getLiveScore"},updateUI)
  );
}

/* ===== CHANGE BOWLER ===== */
function openBowlerChange(){
  setupCard.style.display="block";
  b2.innerHTML="<option value=''>Select Bowler</option>";

  callAPI({action:"getLiveScore"},r=>{
    loadPlayers(r.bowling,"b2");
  });
}

function confirmBowler(){
  if(!b2.value) return alert("Select bowler");

  bowler=b2.value;
  if(!bowlers[bowler]) bowlers[bowler]={balls:0};

  isOverComplete=false;
  setupCard.style.display="none";
  disableEntry(false);
}

/* ===== LOAD PLAYERS ===== */
function loadPlayers(team,...ids){
  callAPI({action:"getPlayers",team},players=>{
    ids.forEach(id=>{
      const s=document.getElementById(id);
      s.innerHTML="<option value=''>Select Bowler</option>";
      players.forEach(p=>{
        const o=document.createElement("option");
        o.value=p.name;
        o.textContent=p.name;
        s.appendChild(o);
      });
    });
  });
}

/* ===== START 2ND INNINGS ===== */
function startSecondInnings(){
  callAPI({action:"startSecondInnings"},()=>{
    location.reload();
  });
}

/* ===== INIT ===== */
window.onload=()=>{
  callAPI({action:"getLiveScore"},r=>{
    striker=r.striker;
    nonStriker=r.nonstriker;
    bowler=r.bowler;

    batsmen[striker]={runs:0,balls:0};
    batsmen[nonStriker]={runs:0,balls:0};
    bowlers[bowler]={balls:0};

    updateUI(r);
  });
};
</script>
</head>

<body>
<div class="header">
  <div class="back" onclick="location.href='dashboard.html'">â¬…</div>
  Score Entry
</div>

<div class="container">

<div class="card">
  <div class="score" id="score">0 / 0</div>
  <div class="sub" id="overs">Overs: 0.0</div>

  <div class="small" id="strikerBox"></div>
  <div class="small" id="nonBox"></div>
  <div class="small" id="bowlerBox"></div>

  <button id="changeBowlerBtn" style="display:none;background:#ff9800" onclick="openBowlerChange()">
    ðŸ”„ Change Bowler
  </button>

  <button id="secondInningsBtn" style="display:none;background:#4caf50" onclick="startSecondInnings()">
    â–¶ Start 2nd Innings
  </button>
</div>

<div class="card" id="setupCard" style="display:none">
  <h3>Select Bowler</h3>
  <select id="b2"></select>
  <button style="margin-top:10px;background:#4caf50" onclick="confirmBowler()">Confirm Bowler</button>
</div>

<div class="card">
  <div class="grid">
    <button class="score-btn" onclick="send('run',0)">0</button>
    <button class="score-btn" onclick="send('run',1)">1</button>
    <button class="score-btn" onclick="send('run',2)">2</button>
    <button class="score-btn" onclick="send('run',3)">3</button>
    <button class="score-btn" onclick="send('run',4)">4</button>
    <button class="score-btn" onclick="send('run',6)">6</button>
  </div>
</div>

<div class="card">
  <div class="grid">
    <button class="extra score-btn" onclick="send('wide')">Wide</button>
    <button class="extra score-btn" onclick="send('noball')">No Ball</button>
    <button class="wicket score-btn" onclick="send('wicket')">Wicket</button>
  </div>
</div>

</div>
</body>
</html>
