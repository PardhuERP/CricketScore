<!DOCTYPE html>
<html>
<head>
  <title>Playing 11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial;
      background: #0f172a;
      color: #fff;
      margin: 0;
    }
    .header {
      background: #020617;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    .container { padding: 15px; }
    .player-row {
      background: #1e293b;
      margin-bottom: 6px;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .actions {
      display: flex;
      gap: 6px;
      font-size: 12px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: #22c55e;
      color: #000;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
    }
    .note { font-size: 13px; color: #94a3b8; margin-bottom: 6px; }
  </style>
</head>

<body>

<div class="header">Select Playing 11</div>
<div class="container">
  <div id="teamName"></div>
  <div id="countInfo" class="note">Main: 0 / 11 | Subs: 0 / 3</div>
  <div id="players"></div>
  <button onclick="saveXI()">Save Playing 11</button>
</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbze43b5gQyZ5s0q7pln3C18nW5nkQuBhjX-vHq8DC6r8-hLc2dScQn2ifHWvZTx3I8I/exec";
const token = localStorage.getItem("token");

const urlParams = new URLSearchParams(window.location.search);
const matchId = urlParams.get("matchId");

let TEAM_ID = null;
let PLAYER_DATA = [];

if (!token || !matchId) {
  alert("Invalid session");
  window.location.href = "dashboard.html";
}

// Get my team
fetch(BASE_URL + "?action=getMyTeam&token=" + token)
  .then(r => r.json())
  .then(d => {
    TEAM_ID = d.team[0];
    teamName.innerHTML = `<b>Team:</b> ${d.team[2]}`;
    loadPlayers();
  });

function loadPlayers() {
  fetch(BASE_URL + "?action=getPlayers&teamId=" + TEAM_ID)
    .then(r => r.json())
    .then(d => {
      PLAYER_DATA = d.players;
      renderPlayers();
      updateCount();
    });
}

function renderPlayers() {
  players.innerHTML = "";

  PLAYER_DATA.forEach(p => {
    players.innerHTML += `
      <div class="player-row">
        <div>
          <input type="checkbox" class="sel" value="${p[0]}" onchange="updateCount()">
          ${p[2]}
        </div>
        <div class="actions">
          C <input type="radio" name="captain" value="${p[0]}">
          WK <input type="radio" name="keeper" value="${p[0]}">
          SUB <input type="checkbox" class="sub" value="${p[0]}" onchange="updateCount()">
        </div>
      </div>
    `;
  });
}

function updateCount() {
  const mainCount = document.querySelectorAll(".sel:checked").length;
  const subCount = document.querySelectorAll(".sub:checked").length;

  countInfo.innerText = `Main: ${mainCount} / 11 | Subs: ${subCount} / 3`;

  if (mainCount > 11 || subCount > 3) {
    countInfo.style.color = "red";
  } else {
    countInfo.style.color = "#94a3b8";
  }
}

function saveXI() {
  const selected = [...document.querySelectorAll(".sel:checked")].map(i => i.value);
  const captain = document.querySelector("input[name=captain]:checked")?.value;
  const keeper = document.querySelector("input[name=keeper]:checked")?.value;
  const subs = [...document.querySelectorAll(".sub:checked")].map(i => i.value);

  // 1. Exactly 11 main players
  if (selected.length !== 11) {
    alert("You must select exactly 11 main players");
    return;
  }

  // 2. Captain & Keeper must be from main 11
  if (!captain || !keeper) {
    alert("Captain and Wicket Keeper required");
    return;
  }
  if (!selected.includes(captain) || !selected.includes(keeper)) {
    alert("Captain and Keeper must be from Playing 11");
    return;
  }

  // 3. Subs max 3
  if (subs.length > 3) {
    alert("Maximum 3 substitutes allowed");
    return;
  }

  // 4. Subs cannot be part of main 11
  for (let s of subs) {
    if (selected.includes(s)) {
      alert("Substitutes cannot be part of Playing 11");
      return;
    }
      // 5. Warn if no substitutes
if (subs.length === 0) {
  const proceed = confirm("You didnâ€™t add any substitutes. Continue without subs?");
  if (!proceed) return;
    }
  }

  // Build payload
  let payload = [];

  // Main XI
  selected.forEach(pid => {
    payload.push({
      playerId: pid,
      isCaptain: pid === captain,
      isKeeper: pid === keeper,
      isSubstitute: false
    });
  });

  // Subs
  subs.forEach(pid => {
    payload.push({
      playerId: pid,
      isCaptain: false,
      isKeeper: false,
      isSubstitute: true
    });
  });

  fetch(BASE_URL + "?action=savePlaying11", {
    method: "POST",
    body: JSON.stringify({
      matchId: matchId,
      teamId: TEAM_ID,
      players: JSON.stringify(payload)
    })
  })
  .then(r => r.json())
  .then(d => {
    alert("Playing 11 saved");
    window.location.href = "toss.html?matchId=" + matchId;
  });
}
</script>

</body>
</html>
