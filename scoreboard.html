<!DOCTYPE html>
<html>
<head>
  <title>LocalCricketApp - Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; background:#0f172a; color:#fff; margin:0; }
    .header { background:#020617; padding:15px; text-align:center; font-weight:bold; font-size:18px; }
    .container { padding:15px; }

    .score { font-size:32px; text-align:center; margin:10px 0; font-weight:bold; }

    .meta {
      display:flex;
      justify-content:space-between;
      font-size:13px;
      margin-bottom:10px;
      opacity:0.9;
    }

    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td { padding:6px; text-align:center; border-bottom:1px solid #334155; }
    th { color:#38bdf8; }

    .btns {
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap:8px;
      margin-top:15px;
    }

    button {
      padding:12px;
      font-size:16px;
      border:none;
      border-radius:6px;
      background:#22c55e;
      color:#000;
      font-weight:bold;
    }

    .extra { background:#38bdf8; }
    .wicket { background:#ef4444; color:#fff; }
    .undo { background:#facc15; }
  </style>
</head>

<body>

<div class="header">Live Score</div>

<div class="container">

  <div id="teamName"></div>

  <div class="score" id="mainScore">0/0 (0.0)</div>

  <div class="meta">
    <div id="crr">CRR: 0.00</div>
    <div id="partnership">P'SHIP: 0 (0)</div>
  </div>

  <table id="batsmenTable"></table>
  <table id="bowlerTable"></table>

  <hr>

  <div class="btns">
    <button onclick="sendBall(0)">0</button>
    <button onclick="sendBall(1)">1</button>
    <button onclick="sendBall(2)">2</button>
    <button onclick="sendBall(3)">3</button>
    <button onclick="sendBall(4)">4</button>
    <button onclick="sendBall(6)">6</button>

    <button class="extra" onclick="sendExtra('WD')">Wide</button>
    <button class="extra" onclick="sendExtra('NB')">No Ball</button>

    <button class="wicket" onclick="sendWicket('OUT')">Wicket</button>
    <button class="undo" onclick="undo()">Undo</button>
  </div>

</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbze43b5gQyZ5s0q7pln3C18nW5nkQuBhjX-vHq8DC6r8-hLc2dScQn2ifHWvZTx3I8I/exec";
const matchId = new URLSearchParams(window.location.search).get("matchId");
const innings = 1;

let strikerId = "";
let nonStrikerId = "";
let bowlerId = "";

/* Load opening players */
function loadOpening() {
  fetch(BASE_URL + "?action=getOpeningPlayers&matchId=" + matchId)
    .then(r => r.json())
    .then(d => {
      strikerId = d.strikerId;
      nonStrikerId = d.nonStrikerId;
      bowlerId = d.bowlerId;
      refresh();
    });
}

/* Refresh scoreboard */
function refresh() {
  fetch(BASE_URL + "?action=getLiveScore&matchId=" + matchId + "&innings=" + innings)
    .then(r => r.json())
    .then(d => render(d));
}

/* Render UI */
function render(d) {
  teamName.innerText = d.battingTeamName + " vs " + d.bowlingTeamName;
  mainScore.innerText = `${d.totalRuns}/${d.wickets} (${d.overs})`;
  crr.innerText = "CRR: " + d.crr;
  partnership.innerText = `P'SHIP: ${d.partnership.runs} (${d.partnership.balls})`;

  batsmenTable.innerHTML = `
    <tr><th>Batter</th><th>R</th><th>B</th><th>4</th><th>6</th><th>SR</th></tr>
  `;
  d.batsmen.forEach(b => {
    batsmenTable.innerHTML += `
      <tr>
        <td>${b.isStriker ? "*" : ""} ${b.name}</td>
        <td>${b.runs}</td>
        <td>${b.balls}</td>
        <td>${b.fours}</td>
        <td>${b.sixes}</td>
        <td>${b.sr}</td>
      </tr>
    `;
  });

  bowlerTable.innerHTML = `
    <tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>ECO</th></tr>
    <tr>
      <td>* ${d.bowler.name}</td>
      <td>${d.bowler.overs}</td>
      <td>${d.bowler.maidens}</td>
      <td>${d.bowler.runs}</td>
      <td>${d.bowler.wickets}</td>
      <td>${d.bowler.eco}</td>
    </tr>
  `;
}

/* FIRE & FORGET (CORS safe) */
function fire(url){
  const img = new Image();
  img.src = url + "&_t=" + Date.now();
}

/* BALL */
function sendBall(runs){
  fire(`${BASE_URL}?action=addBall&matchId=${matchId}&innings=${innings}&strikerId=${strikerId}&nonStrikerId=${nonStrikerId}&bowlerId=${bowlerId}&runsTotal=${runs}&runsOfBat=${runs}`);
  setTimeout(refresh, 400);
}

/* EXTRA */
function sendExtra(type){
  fire(`${BASE_URL}?action=addBall&matchId=${matchId}&innings=${innings}&strikerId=${strikerId}&nonStrikerId=${nonStrikerId}&bowlerId=${bowlerId}&runsTotal=1&runsOfBat=0&extraType=${type}`);
  setTimeout(refresh, 400);
}

/* WICKET */
function sendWicket(type){
  fire(`${BASE_URL}?action=addBall&matchId=${matchId}&innings=${innings}&strikerId=${strikerId}&nonStrikerId=${nonStrikerId}&bowlerId=${bowlerId}&runsTotal=0&runsOfBat=0&wicketType=${type}`);
  setTimeout(refresh, 400);
}

/* UNDO */
function undo(){
  fire(`${BASE_URL}?action=undoLastBall&matchId=${matchId}&innings=${innings}`);
  setTimeout(refresh, 400);
}

loadOpening();
</script>

</body>
</html>
