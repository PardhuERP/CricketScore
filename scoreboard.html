<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Scoreboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;background:#0b1220;color:#fff;font-family:Arial}
.header{text-align:center;padding:12px;font-size:20px;font-weight:bold}
.card{padding:12px}
.score{font-size:38px;text-align:center;margin:10px 0}
.sub{text-align:center;color:#aaa;margin-bottom:10px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px}
.btn{padding:16px;border-radius:10px;text-align:center;font-size:16px;font-weight:bold;cursor:pointer}
.run{background:#2ecc71}
.extra{background:#3498db}
.wkt{background:#e74c3c}
.undo{background:#f1c40f;color:#000}
.swap{background:#9b59b6}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #333;padding:6px;text-align:center}
</style>
</head>
<body>

<div class="header">Live Score</div>

<div class="card">

  <div id="team">Team</div>

  <div class="score" id="score">0/0 (0.0)</div>

  <div class="sub">
    Striker: <span id="striker">-</span> |
    Non-Striker: <span id="nonStriker">-</span> |
    Bowler: <span id="bowler">-</span>
  </div>

  <div class="sub">
    CRR: <span id="crr">0.00</span> |
    P'SHIP: <span id="pship">0 (0)</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Batter</th><th>R</th><th>B</th><th>4</th><th>6</th><th>SR</th>
      </tr>
    </thead>
    <tbody id="batBody"></tbody>
  </table>

  <table>
    <thead>
      <tr>
        <th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>ECO</th>
      </tr>
    </thead>
    <tbody id="bowlBody"></tbody>
  </table>

</div>

<div class="grid">
  <div class="btn run" onclick="sendRun(0)">0</div>
  <div class="btn run" onclick="sendRun(1)">1</div>
  <div class="btn run" onclick="sendRun(2)">2</div>
  <div class="btn run" onclick="sendRun(3)">3</div>
  <div class="btn run" onclick="sendRun(4)">4</div>
  <div class="btn run" onclick="sendRun(6)">6</div>

  <div class="btn extra" onclick="sendWide()">Wide</div>
  <div class="btn extra" onclick="sendNoBall()">NoBall</div>
  <div class="btn extra" onclick="sendLegBye()">LegBye</div>

  <div class="btn wkt" onclick="sendWicket('Bowled')">Wicket</div>
  <div class="btn swap" onclick="manualSwap()">Swap</div>
  <div class="btn undo" onclick="undo()">Undo</div>
</div>

<script src="config.js"></script>

<script>

const matchId =
  new URLSearchParams(window.location.search).get("matchId") || "M1";

let innings = 1;

window.onload = function(){
  loadScore();
};

/* ================= SAFE API CALL ================= */

function callApi(data, cb){

  if(!data.action){
    console.error("Action missing");
    return;
  }

  const params = Object.keys(data)
    .map(k => k + "=" + encodeURIComponent(data[k]))
    .join("&");

  const url = API + "?" + params;

  fetch(url)
    .then(r => r.json())
    .then(d=>{
      if(cb) cb(d);
    })
    .catch(err=>{
      console.error("FETCH ERROR:", err);
    });
}

/* ================= LOAD SCORE ================= */

function loadScore(){

  callApi({
    action:"getLiveScore",
    matchId:matchId,
    innings:innings
  }, updateUI);
}

/* ================= UPDATE UI ================= */

function updateUI(res){

  if(!res || !res.score) return;

  const s = res.score;

  document.getElementById("score").innerText =
    s.runs + "/" + s.wickets +
    " (" + s.overs + "." + s.balls + ")";

  /* CRR */
  const totalOvers = s.overs + (s.balls/6);
  const crr = totalOvers > 0 ? (s.runs / totalOvers).toFixed(2) : "0.00";
  document.getElementById("crr").innerText = crr;

  /* STRIKER + BOWLER */
  document.getElementById("striker").innerText =
    res.strikerId || "-";

  document.getElementById("nonStriker").innerText =
    res.nonStrikerId || "-";

  document.getElementById("bowler").innerText =
    res.bowlerId || "-";

  /* BATSMEN */
  let batHtml="";
  let pRuns=0;
  let pBalls=0;

  (s.batsmen || []).forEach(b=>{

    const isStriker = (b.playerId === res.strikerId);
    const name = isStriker ? "*"+b.playerId : b.playerId;

    const sr = b.balls > 0
      ? ((b.runs / b.balls)*100).toFixed(2)
      : "0.00";

    if(!b.out){
      pRuns += b.runs;
      pBalls += b.balls;
    }

    batHtml += `
      <tr>
        <td>${name}</td>
        <td>${b.runs}</td>
        <td>${b.balls}</td>
        <td>${b.fours || 0}</td>
        <td>${b.sixes || 0}</td>
        <td>${sr}</td>
      </tr>
    `;
  });

  document.getElementById("batBody").innerHTML = batHtml;
  document.getElementById("pship").innerText =
    pRuns + " (" + pBalls + ")";

  /* BOWLERS */
  let bowlHtml="";

  (s.bowlers || []).forEach(b=>{

    const isCurrent = (b.playerId === res.bowlerId);
    const name = isCurrent ? "*"+b.playerId : b.playerId;

    const overs = (b.balls/6).toFixed(1);
    const eco = b.balls > 0
      ? ((b.runs/(b.balls/6))).toFixed(2)
      : "0.00";

    bowlHtml += `
      <tr>
        <td>${name}</td>
        <td>${overs}</td>
        <td>0</td>
        <td>${b.runs}</td>
        <td>${b.wickets}</td>
        <td>${eco}</td>
      </tr>
    `;
  });

  document.getElementById("bowlBody").innerHTML = bowlHtml;
}

/* ================= SCORING ================= */

function sendRun(r){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:innings,
    runBat:r
  }, loadScore);
}

function sendWide(){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:innings,
    isWide:true,
    extraRuns:1
  }, loadScore);
}

function sendNoBall(){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:innings,
    isNoBall:true,
    extraRuns:1
  }, loadScore);
}

function sendLegBye(){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:innings,
    isLegBye:true,
    extraRuns:1
  }, loadScore);
}

function sendWicket(type){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:innings,
    wicket:true,
    wicketType:type
  }, loadScore);
}

function undo(){
  callApi({
    action:"undoLastBall",
    matchId:matchId,
    innings:innings
  }, loadScore);
}

function manualSwap(){
  let s = document.getElementById("striker").innerText;
  let ns = document.getElementById("nonStriker").innerText;
  document.getElementById("striker").innerText = ns;
  document.getElementById("nonStriker").innerText = s;
}

</script>

</body>
</html>
