<!DOCTYPE html>
<html>
<head>
  <title>Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; background:#0f172a; color:#fff; margin:0; }
    .header { background:#020617; padding:15px; text-align:center; font-weight:bold; }

    .container { padding:15px; }

    .team-pill {
      background:#1e293b;
      padding:8px 16px;
      border-radius:20px;
      display:inline-block;
      margin:10px auto;
      font-weight:bold;
    }

    .score {
      font-size:36px;
      text-align:center;
      margin:8px 0;
      font-weight:bold;
    }

    .meta {
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin-bottom:10px;
      color:#cbd5f5;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }

    th, td {
      padding:6px;
      text-align:center;
      border-bottom:1px solid #334155;
    }

    th { color:#93c5fd; }

    .btns {
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap:8px;
      margin-top:15px;
    }

    button {
      padding:14px;
      font-size:16px;
      border:none;
      border-radius:8px;
      background:#22c55e;
      color:#000;
      font-weight:bold;
    }

    .extra { background:#38bdf8; }
    .wicket { background:#ef4444; color:#fff; }
    .undo { background:#facc15; }
  </style>
</head>

<body>

<div class="header">Live Score</div>

<div class="container">

  <div style="text-align:center">
    <div id="teamName" class="team-pill">Batting Team</div>
  </div>

  <div id="mainScore" class="score">0/0 (0.0)</div>

  <div class="meta">
    <div id="crr">CRR 0.00</div>
    <div id="partnership">P'SHIP 0 (0)</div>
  </div>

  <table id="batsmenTable"></table>
  <table id="bowlerTable"></table>

  <div class="btns">
    <button onclick="addRun(0)">0</button>
    <button onclick="addRun(1)">1</button>
    <button onclick="addRun(2)">2</button>
    <button onclick="addRun(3)">3</button>
    <button onclick="addRun(4)">4</button>
    <button onclick="addRun(5)">5</button>
    <button onclick="addRun(6)">6</button>

    <button class="extra" onclick="addExtra('WD')">Wide</button>
    <button class="extra" onclick="addExtra('NB')">No Ball</button>
    <button class="extra" onclick="addExtra('LB')">Leg Bye</button>

    <button class="wicket" onclick="addWicket('OUT')">Wicket</button>
    <button class="wicket" onclick="addWicket('RUNOUT')">Run Out</button>

    <button class="undo" onclick="undo()">Undo</button>
  </div>

</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbze43b5gQyZ5s0q7pln3C18nW5nkQuBhjX-vHq8DC6r8-hLc2dScQn2ifHWvZTx3I8I/exec";
const matchId = new URLSearchParams(window.location.search).get("matchId");

let innings = 1;
let strikerId = null;
let nonStrikerId = null;
let bowlerId = null;

/* 1. Load opening players first */
fetch(BASE_URL + "?action=getOpeningPlayers&matchId=" + matchId)
  .then(r => r.json())
  .then(op => {

    if (!op.data) {
      alert("Opening players not set");
      window.location.href = "openingplayers.html?matchId=" + matchId;
      return;
    }

    strikerId    = op.data[3];
    nonStrikerId = op.data[4];
    bowlerId     = op.data[5];

    console.log("STEP1 OPENING:", strikerId, nonStrikerId, bowlerId);

    loadScore();
  });

/* 2. Load live score */
function loadScore() {
  fetch(BASE_URL + "?action=getLiveScore&matchId=" + matchId + "&innings=" + innings)
    .then(r => r.json())
    .then(d => {
      renderScore(d);
    });
}

function renderScore(d) {
  teamName.innerText = d.battingTeamName;
  mainScore.innerText = `${d.totalRuns}/${d.wickets} (${d.overs})`;
  crr.innerText = "CRR " + d.crr;
  partnership.innerText = `P'SHIP ${d.partnership.runs} (${d.partnership.balls})`;

  // Batsmen
  batsmenTable.innerHTML = `
    <tr><th>Batter</th><th>R</th><th>B</th><th>4</th><th>6</th><th>SR</th></tr>
  `;

  d.batsmen.forEach(b => {
    batsmenTable.innerHTML += `
      <tr>
        <td>${b.isStriker ? "*" : ""} ${b.name}</td>
        <td>${b.runs}</td>
        <td>${b.balls}</td>
        <td>${b.fours}</td>
        <td>${b.sixes}</td>
        <td>${b.sr}</td>
      </tr>
    `;
  });

  // Bowler
  bowlerTable.innerHTML = `
    <tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>ECO</th></tr>
    <tr>
      <td>* ${d.bowler.name}</td>
      <td>${d.bowler.overs}</td>
      <td>${d.bowler.maidens}</td>
      <td>${d.bowler.runs}</td>
      <td>${d.bowler.wickets}</td>
      <td>${d.bowler.eco}</td>
    </tr>
  `;
}

/* Actions */

function addRun(run) {
  addBall(run, "", "");
}

function addExtra(type) {
  addBall(1, type, "");
}

function addWicket(type) {
  addBall(0, "", type);
}

function addBall(runs, extraType, wicketType) {
  fetch(BASE_URL + "?action=addBall", {
    method:"POST",
    body: JSON.stringify({
      matchId,
      innings,
      strikerId,
      nonStrikerId,
      bowlerId,
      runs,
      extraType,
      wicketType
    })
  })
  .then(r => r.json())
  .then(d => {
  strikerId = d.strikerId;
  nonStrikerId = d.nonStrikerId;
  bowlerId = d.bowlerId;

  if (d.overCompleted) {
    alert("Over completed. Select new bowler.");
    // later we will redirect to bowler selection page
  }

  loadScore();
});

function undo() {
  fetch(BASE_URL + "?action=undoLastBall", {
    method:"POST",
    body: JSON.stringify({ matchId, innings })
  })
  .then(r => r.json())
  .then(d => {
    loadScore();
  });
}
</script>

</body>
</html>
