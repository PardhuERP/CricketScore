<!DOCTYPE html>
<html>
<head>
  <title>Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; background:#0f172a; color:#fff; margin:0; }
    .header { background:#020617; padding:15px; text-align:center; font-weight:bold; }
    .container { padding:15px; }
    .score { font-size:32px; text-align:center; margin:10px 0; }
    .row { margin:6px 0; }
    .btns { display:grid; grid-template-columns: repeat(4,1fr); gap:8px; }
    button { padding:12px; font-size:16px; border:none; border-radius:6px; background:#22c55e; color:#000; font-weight:bold; }
    .extra { background:#38bdf8; }
    .wicket { background:#ef4444; color:#fff; }
    .undo { background:#facc15; }
  </style>
</head>

<body>

<div class="header">Live Score</div>

<div class="container">
  <div id="teamName"></div>
<div id="mainScore"></div>

<div class="meta">
  <div id="crr"></div>
  <div id="partnership"></div>
</div>

<table id="batsmenTable"></table>
<table id="bowlerTable"></table>

  <hr>

  <div class="btns">
    <button onclick="addRun(0)">0</button>
    <button onclick="addRun(1)">1</button>
    <button onclick="addRun(2)">2</button>
    <button onclick="addRun(3)">3</button>
    <button onclick="addRun(4)">4</button>
    <button onclick="addRun(5)">5</button>
    <button onclick="addRun(6)">6</button>

    <button class="extra" onclick="addExtra('WD')">Wide</button>
    <button class="extra" onclick="addExtra('NB')">No Ball</button>
    <button class="extra" onclick="addExtra('LB')">Leg Bye</button>

    <button class="wicket" onclick="addWicket('OUT')">Wicket</button>
    <button class="wicket" onclick="addWicket('RUNOUT')">Run Out</button>

    <button class="undo" onclick="undo()">Undo</button>
  </div>
</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbze43b5gQyZ5s0q7pln3C18nW5nkQuBhjX-vHq8DC6r8-hLc2dScQn2ifHWvZTx3I8I/exec";
const matchId = new URLSearchParams(window.location.search).get("matchId");

let innings = 1;

// TEMP (we will replace with real from opening players)
let strikerId = "P1";
let nonStrikerId = "P2";
let bowlerId = "P3";

function loadScore() {
  fetch(BASE_URL + "?action=getLiveScore&matchId=" + matchId + "&innings=" + innings)
    .then(r => r.json())
    .then(d => {
      scoreText.innerText = `${d.totalRuns}/${d.wickets} (${d.overs})`;
    });
}

function renderScore(d) {
  teamName.innerText = d.battingTeamName;
  mainScore.innerText = `${d.totalRuns}/${d.wickets} (${d.overs})`;
  crr.innerText = "CRR: " + d.crr;
  partnership.innerText = `P'SHIP: ${d.partnership.runs} (${d.partnership.balls})`;

  // Batsmen
  batsmenTable.innerHTML = `
    <tr><th>Batter</th><th>R</th><th>B</th><th>4</th><th>6</th><th>SR</th></tr>
  `;
  d.batsmen.forEach(b => {
    batsmenTable.innerHTML += `
      <tr>
        <td>${b.isStriker ? "*" : ""} ${b.name}</td>
        <td>${b.runs}</td>
        <td>${b.balls}</td>
        <td>${b.fours}</td>
        <td>${b.sixes}</td>
        <td>${b.sr}</td>
      </tr>
    `;
  });

  // Bowler
  bowlerTable.innerHTML = `
    <tr><th>Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>ECO</th></tr>
    <tr>
      <td>* ${d.bowler.name}</td>
      <td>${d.bowler.overs}</td>
      <td>${d.bowler.maidens}</td>
      <td>${d.bowler.runs}</td>
      <td>${d.bowler.wickets}</td>
      <td>${d.bowler.eco}</td>
    </tr>
  `;
}
  
function addRun(run) {
  addBall(run, "", "");
}

function addExtra(type) {
  addBall(1, type, "");
}

function addWicket(type) {
  addBall(0, "", type);
}

function addBall(runs, extraType, wicketType) {
  fetch(BASE_URL + "?action=addBall", {
    method:"POST",
    body: JSON.stringify({
      matchId: matchId,
      innings: innings,
      strikerId: strikerId,
      nonStrikerId: nonStrikerId,
      bowlerId: bowlerId,
      runs: runs,
      extraType: extraType,
      wicketType: wicketType
    })
  })
  .then(r => r.json())
  .then(d => {
    loadScore();
  });
}

function undo() {
  fetch(BASE_URL + "?action=undoLastBall", {
    method:"POST",
    body: JSON.stringify({
      matchId: matchId,
      innings: innings
    })
  })
  .then(r => r.json())
  .then(d => {
    loadScore();
  });
}

loadScore();
</script>

</body>
</html>
