<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Cricket Scorer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;background:#0b1220;color:#fff;font-family:Arial}
.header{text-align:center;padding:12px;font-size:22px;font-weight:bold}
.card{padding:10px}
.score{font-size:42px;text-align:center}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px}
.btn{padding:18px;border-radius:10px;text-align:center;font-size:18px;font-weight:bold;cursor:pointer}
.run{background:#2ecc71}
.extra{background:#3498db}
.wkt{background:#e74c3c}
.undo{background:#f1c40f;color:#000}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #333;padding:6px;text-align:center}
</style>
</head>
<body>

<div class="header">Live Score</div>

<div class="card">
  <div id="team">Team</div>
  <div class="score" id="score">0/0 (0.0)</div>
  <div>CRR: <span id="crr">0.00</span></div>

  <!-- BATSMAN TABLE -->
  <table>
    <thead>
      <tr>
        <th>Batter</th>
        <th>R</th>
        <th>B</th>
      </tr>
    </thead>
    <tbody id="batBody"></tbody>
  </table>

  <!-- BOWLER TABLE -->
  <table>
    <thead>
      <tr>
        <th>Bowler</th>
        <th>R</th>
        <th>W</th>
      </tr>
    </thead>
    <tbody id="bowlBody"></tbody>
  </table>
</div>

<div class="grid">
  <div class="btn run" onclick="sendRun(0)">0</div>
  <div class="btn run" onclick="sendRun(1)">1</div>
  <div class="btn run" onclick="sendRun(2)">2</div>
  <div class="btn run" onclick="sendRun(3)">3</div>
  <div class="btn run" onclick="sendRun(4)">4</div>
  <div class="btn run" onclick="sendRun(5)">5</div>
  <div class="btn run" onclick="sendRun(6)">6</div>

  <div class="btn extra" onclick="sendWide()">Wide</div>
  <div class="btn extra" onclick="sendNoBall()">No Ball</div>
  <div class="btn extra" onclick="sendLegBye()">Leg Bye</div>

  <div class="btn wkt" onclick="sendWicket('Bowled')">Wicket</div>
  <div class="btn wkt" onclick="sendWicket('Run out')">Run Out</div>

  <div class="btn undo" onclick="undo()">Undo</div>
</div>

<script>

/* =========================
   API CONFIG
========================= */
const API = "https://script.google.com/macros/s/AKfycbyxqGY4gx6SPBqwqJAi4q3_RP1hzYie1DO-AeFJ_WREkPt3DPDWnoBUIFMSOs9kC2Ao/exec";

/* =========================
   GET MATCH ID
========================= */
const matchId = new URLSearchParams(window.location.search).get("matchId") || "M1";

/* =========================
   UNIVERSAL API CALL
========================= */
function callApi(data, callback){

  if(!data.action){
    console.error("No action provided");
    return;
  }

  const params = Object.keys(data)
    .map(k => k + "=" + encodeURIComponent(data[k]))
    .join("&");

  fetch(API + "?" + params)
    .then(r => r.json())
    .then(d => {
      console.log("API:", d);
      if(callback) callback(d);
    })
    .catch(err => console.error(err));
}

/* =========================
   LOAD SCORE
========================= */
window.onload = loadScore;

function loadScore(){
  callApi({
    action:"getLiveScore",
    matchId:matchId,
    innings:1
  }, updateUI);
}

/* =========================
   UPDATE UI
========================= */
function updateUI(res){

  if(!res.score) return;

  const s = res.score;

  document.getElementById("score").innerText =
    s.runs + "/" + s.wickets + " (" + s.overs + "." + s.balls + ")";

  document.getElementById("crr").innerText =
    s.overs > 0 ? (s.runs / s.overs).toFixed(2) : "0.00";

  /* BATTERS */
  let batHtml="";
  s.batsmen.forEach(b=>{
    batHtml += `
      <tr>
        <td>${b.playerId}</td>
        <td>${b.runs}</td>
        <td>${b.balls}</td>
      </tr>
    `;
  });
  document.getElementById("batBody").innerHTML = batHtml;

  /* BOWLER */
  let bowlHtml="";
  s.bowlers.forEach(b=>{
    bowlHtml += `
      <tr>
        <td>${b.playerId}</td>
        <td>${b.runs}</td>
        <td>${b.wickets}</td>
      </tr>
    `;
  });
  document.getElementById("bowlBody").innerHTML = bowlHtml;
}

/* =========================
   SEND BALL
========================= */
function sendRun(r){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:1,
    runBat:r,
    isWide:false,
    isNoBall:false,
    isLegBye:false,
    extraRuns:0,
    wicket:false
  }, loadScore);
}

function sendWide(){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:1,
    runBat:0,
    isWide:true,
    extraRuns:1
  }, loadScore);
}

function sendNoBall(){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:1,
    runBat:0,
    isNoBall:true,
    extraRuns:1
  }, loadScore);
}

function sendLegBye(){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:1,
    runBat:0,
    isLegBye:true,
    extraRuns:1
  }, loadScore);
}

function sendWicket(type){
  callApi({
    action:"addBall",
    matchId:matchId,
    innings:1,
    runBat:0,
    wicket:true,
    wicketType:type
  }, loadScore);
}

/* =========================
   UNDO
========================= */
function undo(){
  callApi({
    action:"undoLastBall",
    matchId:matchId,
    innings:1
  }, loadScore);
}

</script>

</body>
</html>
