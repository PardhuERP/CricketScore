<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Match Setup</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f2f4f8}
.header{background:#0a7cff;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:bold}
.container{padding:14px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;
      box-shadow:0 4px 10px rgba(0,0,0,0.08)}
label{display:block;margin-top:10px;font-weight:bold}
input,select,button{
  width:100%;padding:12px;margin-top:6px;
  border-radius:8px;border:1px solid #ccc;font-size:16px
}
button{
  background:#4caf50;color:#fff;border:none;
  margin-top:18px;font-size:18px
}
</style>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzdz3UnRjf-nDbzd9WCdKpQG32jXc1ehGKeXy9q_Czm8ASwHSszmvWlNQa8OSL-6VE/exec";

/* ========= JSONP ========= */
function callAPI(p,cb){
  const f="cb_"+Date.now();
  window[f]=r=>{cb&&cb(r);delete window[f];s.remove()};
  const q=Object.keys(p).map(k=>k+"="+encodeURIComponent(p[k])).join("&");
  const s=document.createElement("script");
  s.src=API_URL+"?"+q+"&callback="+f;
  document.body.appendChild(s);
}

/* ========= LOAD TEAMS ========= */
function loadTeams(){
  callAPI({action:"getTeams"},teams=>{
    batting.innerHTML='<option value="">Select Batting Team</option>';
    bowling.innerHTML='<option value="">Select Bowling Team</option>';

    teams.forEach(t=>{
      batting.innerHTML+=`<option>${t}</option>`;
      bowling.innerHTML+=`<option>${t}</option>`;
    });
  });
}

/* ========= LOAD PLAYERS ========= */
function loadPlayers(team,selectId){
  if(!team) return;
  callAPI({action:"getPlayers",team},players=>{
    const s=document.getElementById(selectId);
    s.innerHTML='<option value="">Select Player</option>';
    players.forEach(p=>{
      s.innerHTML+=`<option>${p.name}</option>`;
    });
  });
}

/* ========= EVENT BINDS ========= */
function onBattingChange(){
  if(batting.value===bowling.value && bowling.value){
    alert("Batting & Bowling teams must be different");
    batting.value="";
    return;
  }
  loadPlayers(batting.value,"striker");
  loadPlayers(batting.value,"nonstriker");
}

function onBowlingChange(){
  if(batting.value===bowling.value && batting.value){
    alert("Batting & Bowling teams must be different");
    bowling.value="";
    return;
  }
  loadPlayers(bowling.value,"bowler");
}

/* ========= START MATCH ========= */
function startMatch(){
  const match=matchName.value.trim();
  const bat=batting.value;
  const bowl=bowling.value;
  const overs=oversInput.value;
  const s=striker.value;
  const ns=nonstriker.value;
  const b=bowler.value;

  if(!match||!bat||!bowl||!overs||!s||!ns||!b){
    alert("⚠ Please fill ALL match details");
    return;
  }

  callAPI({
    action:"startMatch",
    match,
    batting:bat,
    bowling:bowl,
    overs,
    striker:s,
    nonstriker:ns,
    bowler:b
  },res=>{
    if(res.status==="ok"){
      location.href="score.html";
    }else{
      alert(res.msg||"Match start failed");
    }
  });
}

/* ========= INIT ========= */
window.onload=loadTeams;
</script>
</head>

<body>
<div class="header">Match Setup</div>

<div class="container">
<div class="card">

<label>Match Title</label>
<input id="matchName" placeholder="Team A vs Team B">

<label>Batting Team</label>
<select id="batting" onchange="onBattingChange()"></select>

<label>Bowling Team</label>
<select id="bowling" onchange="onBowlingChange()"></select>

<label>Overs</label>
<input id="oversInput" type="number" min="1" placeholder="Eg: 2">

<label>Striker</label>
<select id="striker"></select>

<label>Non-Striker</label>
<select id="nonstriker"></select>

<label>Bowler</label>
<select id="bowler"></select>

<button onclick="startMatch()">▶ Start Match</button>

</div>
</div>
</body>
</html>
